<div class="page-container">
  <div class="view-controls">
    <h2 class="page-title">{{ displayName }}</h2>
    <div class="flex gap-2">
      <button (click)="toggleViewMode()" [attr.title]="viewMode === 'grid' ? 'Switch to list view' : 'Switch to grid view'"
        class="icon-btn">
        <iconify-icon [icon]="viewMode === 'grid' ? 'heroicons:list-bullet' : 'heroicons:squares-2x2'"
          class="text-lg"></iconify-icon>
      </button>@if (!currentFriendId) {
      <button (click)="openAddGiftDialog()" [attr.title]="'Add new gift'" class="icon-btn">
        <iconify-icon class="text-lg" icon="heroicons:plus"></iconify-icon>
      </button>
      }
    </div>
  </div>

  <div class="content-area">
    @if (gifts.length === 0) {
    <div class="empty-state">
      <iconify-icon class="empty-icon" icon="heroicons:gift"></iconify-icon>
      @if (currentFriendId) {
      <h2>No Gifts Yet</h2>
      <p>This friend hasn't added any gifts to their wishlist yet.</p>
      } @else {
      <h2>No Gifts Yet</h2>
      <p>Start building your wishlist by adding your first gift!</p>
      <button (click)="openAddGiftDialog()"
        class="cta-button inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90">
        <iconify-icon icon="heroicons:plus-circle"></iconify-icon>
        Add Your First Gift
      </button>
      }
    </div>
    } @else {
    @if (viewMode === 'grid') {
    <div class="grid-container">
      @for (gift of gifts; track gift.id) {
      <div class="gift-card grid-item rounded-xl border border-border bg-card shadow-sm">
        @if (currentFriendId && gift.purchased) {
        <div class="purchased-badge">
          <iconify-icon class="text-xl" icon="heroicons:shopping-bag"></iconify-icon>
          <span>Purchased</span>
        </div>
        }
        <div class="card-content">
          <div class="image-container">
            <img (error)="onImageError($event)" [alt]="gift.name" [src]="getImageUrl(gift)" class="gift-image">
          </div>
          <div class="gift-details">
            <div class="gift-header">
              <h3 class="gift-name">{{ gift.name }}</h3>
            </div>
            <p class="gift-description">{{ gift.description }}</p>
            @if (currentFriendId && gift.purchased && gift.purchasedByName) {
            <p class="purchased-info">
              Purchased by {{ gift.purchasedByName }}
              @if (gift.purchasedAt) {
              <span class="purchased-date"> on {{ gift.purchasedAt | date:'mediumDate' }}</span>
              }
            </p>
            }
            <div class="gift-footer">
              <div class="price-info">
                <span class="price">€{{ gift.price }}</span>

                @if (gift.link) {
                <a [href]="gift.link" class="gift-link" rel="noopener noreferrer" target="_blank">
                  <iconify-icon class="text-base" icon="heroicons:link"></iconify-icon>
                  <span>View product</span>
                </a>
                }

                <span class="quantity">
                  <iconify-icon class="text-base" icon="heroicons:hashtag"></iconify-icon>
                  <span>{{ getQuantityDisplayText(gift) }}</span>
                </span>

              </div>
              <div class="action-buttons">
                @if (currentFriendId) {
                <button (click)="togglePurchased(gift)" [attr.title]="canTogglePurchase(gift) ? (gift.purchased ? 'Remove one purchased item' : 'Mark one item as purchased') : 'Only the person who purchased this can unmark it'"
                  [disabled]="!canTogglePurchase(gift)" [ngClass]="{'purchased-state': gift.purchased}"
                  class="icon-btn cart-button">
                  <iconify-icon class="text-lg" icon="heroicons:shopping-bag"></iconify-icon>
                </button>
                } @else {
                <button (click)="openEditGiftDialog(gift)" class="icon-btn edit-button" title="Edit gift">
                  <iconify-icon class="text-lg" icon="heroicons:pencil-square"></iconify-icon>
                </button>
                <button (click)="deleteGift(gift.id)" class="icon-btn delete-button" title="Delete gift">
                  <iconify-icon class="text-lg" icon="heroicons:trash"></iconify-icon>
                </button>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
    } @else {
    <div (cdkDropListDropped)="drop($event)" [attr.data-key]="listRenderKey" [cdkDropListDisabled]="!!currentFriendId" cdkDropList class="list-container">
      @for (gift of gifts; track gift.id) {
      <div [cdkDragDisabled]="!!currentFriendId" cdkDrag class="gift-card list-item rounded-xl border border-border bg-card shadow-sm">
        @if (!currentFriendId) {
        <div cdkDragHandle class="drag-handle">
          <iconify-icon class="text-lg" icon="heroicons:arrows-up-down"></iconify-icon>
        </div>
        }
        @if (currentFriendId && gift.purchased) {
        <div class="purchased-badge">
          <iconify-icon class="text-xl" icon="heroicons:shopping-bag"></iconify-icon>
          <span>Purchased</span>
        </div>
        }
        <div class="card-content">
          <div class="image-container">
            <img (error)="onImageError($event)" [alt]="gift.name" [src]="getImageUrl(gift)" class="gift-image">
          </div>
          <div class="gift-details">
            <div class="gift-header">
              <h3 class="gift-name">{{ gift.name }}</h3>
            </div>
            <p class="gift-description">{{ gift.description }}</p>
            @if (currentFriendId && gift.purchased && gift.purchasedByName) {
            <p class="purchased-info">
              Purchased by {{ gift.purchasedByName }}
              @if (gift.purchasedAt) {
              <span class="purchased-date"> on {{ gift.purchasedAt | date:'mediumDate' }}</span>
              }
            </p>
            }
            <div class="gift-footer">
              <div class="price-info">
                <span class="price">€{{ gift.price }}</span>

                @if (gift.link) {
                <a [href]="gift.link" class="gift-link" rel="noopener noreferrer" target="_blank">
                  <iconify-icon class="text-base" icon="heroicons:link"></iconify-icon>
                  <span>View product</span>
                </a>
                }

                <span class="quantity">
                  <iconify-icon class="text-base" icon="heroicons:hashtag"></iconify-icon>
                  <span>{{ getQuantityDisplayText(gift) }}</span>
                </span>

              </div>
              <div class="action-buttons">
                @if (currentFriendId) {
                <button (click)="togglePurchased(gift)" [attr.title]="canTogglePurchase(gift) ? (gift.purchased ? 'Remove one purchased item' : 'Mark one item as purchased') : 'Only the person who purchased this can unmark it'"
                  [disabled]="!canTogglePurchase(gift)" [ngClass]="{'purchased-state': gift.purchased}"
                  class="icon-btn cart-button">
                  <iconify-icon class="text-lg" icon="heroicons:shopping-bag"></iconify-icon>
                </button>
                } @else {
                <button (click)="openEditGiftDialog(gift)" class="icon-btn edit-button" title="Edit gift">
                  <iconify-icon class="text-lg" icon="heroicons:pencil-square"></iconify-icon>
                </button>
                <button (click)="deleteGift(gift.id)" class="icon-btn delete-button" title="Delete gift">
                  <iconify-icon class="text-lg" icon="heroicons:trash"></iconify-icon>
                </button>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
    }
    }
  </div>
</div>
